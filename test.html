<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Market Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">Crypto Market Test Interface</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Order Form -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Place Order</h2>
                <form id="orderForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Side</label>
                        <select id="side" class="w-full p-2 bg-gray-700 border border-gray-600 rounded">
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Price</label>
                        <input type="number" id="price" step="0.01" value="100.50" class="w-full p-2 bg-gray-700 border border-gray-600 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Quantity</label>
                        <input type="number" id="quantity" step="0.01" value="1.0" class="w-full p-2 bg-gray-700 border border-gray-600 rounded">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded font-medium">
                        Place Order
                    </button>
                </form>
            </div>

            <!-- Order Book -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">Order Book - SOL/USDC</h2>
                <div id="orderBook" class="space-y-2">
                    <!-- Order book will be loaded here -->
                </div>
            </div>
        </div>

        <!-- User Orders -->
        <div class="mt-8 bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Your Orders</h2>
            <div id="userOrders" class="space-y-2">
                <!-- User orders will be loaded here -->
            </div>
        </div>

        <!-- Balance -->
        <div class="mt-8 bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Balance</h2>
            <div id="balance" class="grid grid-cols-2 gap-4">
                <!-- Balance will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';

        // Load order book
        async function loadOrderBook() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/orderbook/SOL-USDC`);
                const data = await response.json();

                const orderBookDiv = document.getElementById('orderBook');
                orderBookDiv.innerHTML = `
                    <div class="text-green-400 mb-2">Bids</div>
                    ${data.bids.slice(0, 5).map(bid => `
                        <div class="flex justify-between text-green-400">
                            <span>${bid.price}</span>
                            <span>${bid.quantity}</span>
                        </div>
                    `).join('')}
                    <div class="border-t border-gray-600 my-2"></div>
                    <div class="text-red-400 mb-2">Asks</div>
                    ${data.asks.slice(0, 5).map(ask => `
                        <div class="flex justify-between text-red-400">
                            <span>${ask.price}</span>
                            <span>${ask.quantity}</span>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Failed to load order book:', error);
            }
        }

        // Load user balance
        async function loadBalance() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/users/user_1/balance?asset=SOL`);
                const solBalance = await response.json();

                const usdcResponse = await fetch(`${API_BASE}/api/v1/users/user_1/balance?asset=USDC`);
                const usdcBalance = await usdcResponse.json();

                const balanceDiv = document.getElementById('balance');
                balanceDiv.innerHTML = `
                    <div>
                        <div class="text-lg font-medium">SOL</div>
                        <div class="text-sm text-gray-400">Available: ${solBalance.available}</div>
                        <div class="text-sm text-gray-400">Locked: ${solBalance.locked}</div>
                    </div>
                    <div>
                        <div class="text-lg font-medium">USDC</div>
                        <div class="text-sm text-gray-400">Available: ${usdcBalance.available}</div>
                        <div class="text-sm text-gray-400">Locked: ${usdcBalance.locked}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load balance:', error);
            }
        }

        // Load user orders
        async function loadUserOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/orders?user_id=user_1`);
                const orders = await response.json();

                const ordersDiv = document.getElementById('userOrders');
                if (orders.length === 0) {
                    ordersDiv.innerHTML = '<div class="text-gray-400">No orders found</div>';
                    return;
                }

                ordersDiv.innerHTML = orders.map(order => `
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded">
                        <div>
                            <div class="font-medium">${order.side.toUpperCase()} ${order.market}</div>
                            <div class="text-sm text-gray-400">Price: ${order.price} | Qty: ${order.quantity}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm">${order.status}</div>
                            ${order.status === 'open' ? `<button onclick="cancelOrder('${order.id}')" class="text-red-400 text-sm hover:text-red-300">Cancel</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        // Place order
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const side = document.getElementById('side').value;
            const price = document.getElementById('price').value;
            const quantity = document.getElementById('quantity').value;

            try {
                const response = await fetch(`${API_BASE}/api/v1/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'secret-key'
                    },
                    body: JSON.stringify({
                        user_id: 'user_1',
                        market: 'SOL-USDC',
                        side,
                        price: parseFloat(price),
                        quantity: parseFloat(quantity)
                    })
                });

                const result = await response.json();
                alert(`Order placed! Order ID: ${result.order_id}`);

                // Refresh data
                loadOrderBook();
                loadUserOrders();
                loadBalance();
            } catch (error) {
                console.error('Failed to place order:', error);
                alert('Failed to place order');
            }
        });

        // Cancel order
        async function cancelOrder(orderId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: 'user_1'
                    })
                });

                if (response.ok) {
                    alert('Order cancelled');
                    loadUserOrders();
                } else {
                    alert('Failed to cancel order');
                }
            } catch (error) {
                console.error('Failed to cancel order:', error);
                alert('Failed to cancel order');
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadOrderBook();
            loadBalance();
            loadUserOrders();
        });
    </script>
</body>
</html>